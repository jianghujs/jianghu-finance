{% extends 'template/jhTemplateV4.html'%}

{% block vueTemplate %}

<!-- 3 table 下  的单表 crud 页面 -->

<!-- SQL START
-- 以下为 jianghu init 工具生成的参考 SQL，使用后删除
-- 创建 page
INSERT INTO `_page` (`pageId`,`pageName`,`pageType`,`sort`,`operation`,`operationByUserId`,`operationByUser`,`operationAt`) SELECT 'voucher-voucherManagement','页面','showInMenu','5','jhInsert',NULL,NULL,NULL FROM DUAL WHERE NOT EXISTS (SELECT `pageId` FROM `_page` WHERE `pageId`='voucher-voucherManagement');

-- 创建 resource
INSERT INTO `_resource` (`accessControlTable`,`resourceHook`,`pageId`,`actionId`,`desc`,`resourceType`,`appDataSchema`,`resourceData`,`requestDemo`,`responseDemo`,`operation`,`operationByUserId`,`operationByUser`,`operationAt`) SELECT NULL,NULL,'voucher-voucherManagement','selectItemList','✅查询-查询列表','sql','{}','{ \"table\": \"voucher\", \"operation\": \"select\" }','','','insert',NULL,NULL,NULL FROM DUAL WHERE NOT EXISTS (SELECT `pageId` FROM `_resource` WHERE `pageId`='voucher-voucherManagement' AND `actionId`='selectItemList');
INSERT INTO `_resource` (`accessControlTable`,`resourceHook`,`pageId`,`actionId`,`desc`,`resourceType`,`appDataSchema`,`resourceData`,`requestDemo`,`responseDemo`,`operation`,`operationByUserId`,`operationByUser`,`operationAt`) SELECT NULL,NULL,'voucher-voucherManagement','insertItem','✅查询-添加成员','sql','{}','{ \"table\": \"voucher\", \"operation\": \"insert\" }','','','insert',NULL,NULL,NULL FROM DUAL WHERE NOT EXISTS (SELECT `pageId` FROM `_resource` WHERE `pageId`='voucher-voucherManagement' AND `actionId`='insertItem');
INSERT INTO `_resource` (`accessControlTable`,`resourceHook`,`pageId`,`actionId`,`desc`,`resourceType`,`appDataSchema`,`resourceData`,`requestDemo`,`responseDemo`,`operation`,`operationByUserId`,`operationByUser`,`operationAt`) SELECT NULL,NULL,'voucher-voucherManagement','updateItem','✅查询-更新成员','sql','{}','{ \"table\": \"voucher\", \"operation\": \"update\" }','','','insert',NULL,NULL,NULL FROM DUAL WHERE NOT EXISTS (SELECT `pageId` FROM `_resource` WHERE `pageId`='voucher-voucherManagement' AND `actionId`='updateItem');
INSERT INTO `_resource` (`accessControlTable`,`resourceHook`,`pageId`,`actionId`,`desc`,`resourceType`,`appDataSchema`,`resourceData`,`requestDemo`,`responseDemo`,`operation`,`operationByUserId`,`operationByUser`,`operationAt`) SELECT NULL,NULL,'voucher-voucherManagement','doDeleteItem','✅查询-删除信息','sql','{}','{ \"table\": \"voucher\", \"operation\": \"delete\" }','','','insert',NULL,NULL,NULL FROM DUAL WHERE NOT EXISTS (SELECT `pageId` FROM `_resource` WHERE `pageId`='voucher-voucherManagement' AND `actionId`='doDeleteItem');
SQL END! -->
<script type="text/html" id="app-template">
<div>
  <v-app mobile-breakpoint="sm">
    <jh-menu />
    <v-main class="mt-15">
      <!-- 头部内容 >>>>>>>>>>>>> -->
      <div class="jh-page-second-bar px-8">
        <v-row align="center">
          <v-col cols="12" xs="12" sm="12" md="4" xl="3">
            <div class="py-4 text-body-1 font-weight-bold d-flex align-center">员工管理
              <!-- 帮助页按钮 -->
              <span role="button" class="success--text font-weight-regular jh-font-size-13 mx-2" @click="jumpToUrl">
                  <v-icon size="13" class="success--text">mdi-help-circle-outline</v-icon>帮助
                </span>
              <select-appaId/>
            </div>
          </v-col>
          <!-- pc端的搜索条件表单 >>>>>>>> -->
          <!-- <<<<<<<< pc端的搜索条件表单 -->
        </v-row>
      </div>
      <!-- <<<<<<<<<<<<< 头部内容 -->

      <div class="jh-page-body-container px-8">

        <!-- 页面主要内容 -->
        <v-container class="fullScreen d-flex flex-column pa-xs-0 pa-0">
          <v-card class="rounded-lg">
            <v-row class="ma-0 px-4 align-center">
              <v-col cols="12" xs="4" sm="4" md="4" xl="4" class="pa-0">
                <v-btn class="elevation-0 mr-2" color="primary" small @click="doUiAction('startCreateItem')">
                  <v-icon size="14">mdi-plus</v-icon>
                  新增员工</v-btn>
          
                <v-btn color="primary" class="elevation-0 mr-2" small @click="doUiAction('exportExcel')" outlined><v-icon size="14">mdi-export-variant</v-icon>导出</v-btn>
                <v-btn color="primary" class="elevation-0 mr-2 d-none d-md-inline-block" small outlined @click="doUiAction('startImportExcel')"><v-icon size="14">mdi-import</v-icon>导入</v-btn>

              </v-col>

              <v-spacer></v-spacer>
              <!-- <v-checkbox
                class="ma-0 mr-2"
                hide-details
                v-model="showAllField"
                label="显示全部信息"
              ></v-checkbox> -->
              <v-switch class="mr-md-2" v-model="showAllField" label="显示全部信息"></v-switch>
              <v-col cols="12" xs="12" sm="4" md="3" xl="2" class="pa-0 mt-2 mt-md-0">
                <v-text-field v-model="searchInput" prefix="搜索" class="jh-v-input" dense filled single-line></v-text-field>
              </v-col>
            </v-row>
            <v-data-table
              fixed-header
              :headers="tableHeader"
              :items="tableData"
              :search="searchInput"
              :footer-props="{ itemsPerPageOptions: [20, 50, -1], itemsPerPageText: '每页行数', itemsPerPageAllText: '所有'}"
              :items-per-page="-1"
              mobile-breakpoint="0"
              :loading="isTableLoading"
              checkbox-color="success"
              :class="{'zebraLine': isTableZebraLineShown }"
              fixed-header
              class="jh-fixed-table-height elevation-0 mt-0 mb-xs-4">
              <template v-slot:header.endowmentInsurance="{ header }">
                <div style="border-bottom: 1px solid #cccccc">{{header.text}}</div>
                <div style="display: flex; flex-direction: row">
                  <template v-for="(tdHeaderItem, index) of insuranceTdField">
                    <span style="flex: 1; min-width: 100px; max-width: 100px;" :style="{'border-right': index < 2 ? '1px solid #cccccc' : '0'}">{{tdHeaderItem.text}}</span>
                  </template>
                </div>
              </template>
              <template v-slot:header.medicalInsurance="{ header }">
                <div style="border-bottom: 1px solid #cccccc">{{header.text}}</div>
                <div style="display: flex; flex-direction: row">
                  <template v-for="(tdHeaderItem, index) of insuranceTdField">
                    <span style="flex: 1; min-width: 100px; max-width: 100px;" :style="{'border-right': index < 2 ? '1px solid #cccccc' : '0'}">{{tdHeaderItem.text}}</span>
                  </template>
                </div>
              </template>
              <template v-slot:header.unemploymentInsurance="{ header }">
                <div style="border-bottom: 1px solid #cccccc">{{header.text}}</div>
                <div style="display: flex; flex-direction: row">
                  <template v-for="(tdHeaderItem, index) of insuranceTdField">
                    <span style="flex: 1; min-width: 100px; max-width: 100px;" :style="{'border-right': index < 2 ? '1px solid #cccccc' : '0'}">{{tdHeaderItem.text}}</span>
                  </template>
                </div>
              </template>
              <template v-slot:header.injuryInsurance="{ header }">
                <div style="border-bottom: 1px solid #cccccc">{{header.text}}</div>
                <div style="display: flex; flex-direction: row">
                  <template v-for="(tdHeaderItem, index) of insuranceTdField">
                    <span style="flex: 1; min-width: 100px; max-width: 100px;" :style="{'border-right': index < 2 ? '1px solid #cccccc' : '0'}">{{tdHeaderItem.text}}</span>
                  </template>
                </div>
              </template>
              <template v-slot:header.maternityInsurance="{ header }">
                <div style="border-bottom: 1px solid #cccccc">{{header.text}}</div>
                <div style="display: flex; flex-direction: row">
                  <template v-for="(tdHeaderItem, index) of insuranceTdField">
                    <span style="flex: 1; min-width: 100px; max-width: 100px;" :style="{'border-right': index < 2 ? '1px solid #cccccc' : '0'}">{{tdHeaderItem.text}}</span>
                  </template>
                </div>
              </template>
              <template v-slot:header.housingFund="{ header }">
                <div style="border-bottom: 1px solid #cccccc">{{header.text}}</div>
                <div style="display: flex; flex-direction: row">
                  <template v-for="(tdHeaderItem, index) of insuranceTdField">
                    <span style="flex: 1; min-width: 100px; max-width: 100px;" :style="{'border-right': index < 2 ? '1px solid #cccccc' : '0'}">{{tdHeaderItem.text}}</span>
                  </template>
                </div>
              </template>
              <!--表格 操作按钮-->
              <template v-slot:item.action="{ item }">
                <template v-if="!isMobile">
                  <span role="button" class="success--text font-weight-medium font-size-2 mr-2" @click="doUiAction('startUpdateItem', item)">
                    <v-icon size="14" class="success--text">mdi-note-edit-outline</v-icon>修改
                  </span>
                  <span role="button" class="error--text font-weight-medium font-size-2" @click="doUiAction('doDeleteItem', item)">
                    <v-icon size="14" class="error--text">mdi-trash-can-outline</v-icon>删除
                  </span>
                </template>
                <v-menu v-if="isMobile" offset-y>
                  <v-list>
                    <v-list-item>
                      <div @click="doUiAction('startUpdateItem', item)">修改</div>
                      <div @click="doUiAction('doDeleteItem', item)"><v-icon size="14">mdi-trash-can-outline</v-icon>删除</div>
                    </v-list-item>
                  </v-list>
                </v-menu>
              </template>
              <template v-slot:item.endowmentInsurance="{ item }">
                <div class="d-flex">
                  <template v-for="tdHeaderItem of insuranceTdField">
                    <span class="insuranceTdField">{{item.insuranceConfig.endowmentInsurance[tdHeaderItem.value]}}</span>
                  </template>
                </div>
              </template>
              <template v-slot:item.medicalInsurance="{ item }">
                <div class="d-flex">
                  <template v-for="tdHeaderItem of insuranceTdField">
                    <span class="insuranceTdField">{{item.insuranceConfig.medicalInsurance[tdHeaderItem.value]}}</span>
                  </template>
                </div>
              </template>
              <template v-slot:item.unemploymentInsurance="{ item }">
                <div class="d-flex">
                  <template v-for="tdHeaderItem of insuranceTdField">
                    <span class="insuranceTdField">{{item.insuranceConfig.unemploymentInsurance[tdHeaderItem.value]}}</span>
                  </template>
                </div>
              </template>
              <template v-slot:item.injuryInsurance="{ item }">
                <div class="d-flex">
                  <template v-for="tdHeaderItem of insuranceTdField">
                    <span class="insuranceTdField">{{item.insuranceConfig.injuryInsurance[tdHeaderItem.value]}}</span>
                  </template>
                </div>
              </template>
              <template v-slot:item.maternityInsurance="{ item }">
                <div class="d-flex">
                  <template v-for="tdHeaderItem of insuranceTdField">
                    <span class="insuranceTdField">{{item.insuranceConfig.maternityInsurance[tdHeaderItem.value]}}</span>
                  </template>
                </div>
              </template>
              <template v-slot:item.housingFund="{ item }">
                <div class="d-flex">
                  <template v-for="tdHeaderItem of insuranceTdField">
                    <span class="insuranceTdField">{{item.insuranceConfig.housingFund[tdHeaderItem.value]}}</span>
                  </template>
                </div>
              </template>
              <!-- 没有数据 -->
              <template v-slot:loading>
                <div class="jh-no-data">数据加载中</div>
              </template>
              <template v-slot:no-data>
                <div class="jh-no-data">暂无数据</div>
              </template>
              <template v-slot:no-results>
                <div class="jh-no-data">暂无数据</div>
              </template>
              <!-- 表格分页 -->
              <template v-slot:footer.page-text="pagination">
                <span>{{pagination.pageStart}}-{{pagination.pageStop}}</span>
                <span class="ml-1">共{{pagination.itemsLength}}条</span>
              </template>
            </v-data-table>
          </v-card>
        </v-container>

        <!-- 新增发票 -->
        <v-navigation-drawer v-model="isAddDrawerShow" :permanent="isAddDrawerShow" fixed temporary right width="1100" class="elevation-24" style="background: #F9F9F9">
          <v-row no-gutters>
            <span class="text-h7 font-weight-bold pa-4">{{addItem.id ? '修改' : '新增'}}员工</span>
          </v-row>
          <v-divider class="jh-divider"></v-divider>

          <v-form class="mt-4" v-model="isFormValid" v-if="isAddDrawerShow" ref="form" lazy-validation>
          
            <!-- 抽屉主体 -->
            <v-skeleton-loader
              v-if="isAddDrawerLoading"
              type="table-heading, list-item-two-line, image"
            ></v-skeleton-loader>
            <template v-else>
              <v-card class="ml-5 mr-5 py-5">
                <v-row class="mt-0 px-4 ml-0 mb-4">
                  <span class="text-h6">基本信息</span>
                </v-row>
                <v-row class="mt-0 px-4">
                  <v-col cols="12" sm="12" md="4" v-for="item of baseFormFields">
                    <span class="jh-input-label"><span v-if="item.required" class="red--text">*</span>{{item.text}}</span>
                    <template v-if="item.formType === 'datePick'">
                      <v-menu
                        v-model="item['menuShown']"
                        :close-on-content-click="false"
                        :nudge-right="40"
                        transition="scale-transition"
                        offset-y
                        min-width="auto"
                      >
                        <template v-slot:activator="{ on, attrs }">
                          <v-text-field class="jh-v-input" readonly v-bind="attrs" v-on="on" dense filled single-line v-model="addItem[item.value]"
                                        :rules="item.required ? validationRules.requireRules : []"></v-text-field>
                        </template>
                        <v-date-picker
                          v-model="addItem[item.value]"
                          locale="zh-CN"
                          class="cus-date-picker"
                          @input="item['menuShown'] = false"
                        ></v-date-picker>
                      </v-menu>
                    </template>
                    <v-autocomplete v-else-if="item.formType === 'select'" class="jh-v-input" dense filled single-line hide-details :items="constantObj[item.value]"
                              :rules="item.required ? validationRules.requireRules : []" v-model="addItem[item.value]"></v-autocomplete>
                    <v-text-field v-else class="jh-v-input " dense filled single-line v-model="addItem[item.value]" :readonly="item.readonly"
                                  :rules="item.required ? validationRules.requireRules : []" @input="onFieldChange($event, item.value)"></v-text-field>
                  </v-col>
                </v-row>
                <v-row class="px-4 ml-0 mt-10">
                  <span class="text-h6">扣除款项</span>
                </v-row>
                <v-row class="px-4 ml-0 pl-1">
                  <v-col cols="12" sm="12" md="12" class="d-flex align-center">
                    <span class="jh-input-label mr-2"><span class="red--text">*</span>是否缴纳五险一金</span>
                    <v-radio-group
                      class="mt-0 pt-0"
                      hide-details
                      v-model="addItem.hasMemberInsurance"
                      row
                    >
                      <v-radio label="是" :value="1"></v-radio>
                      <v-radio label="否" :value="0"></v-radio>
                    </v-radio-group>
                  </v-col>
                </v-row>
                <v-row class="px-4 ml-0 mt-3 pl-1" v-if="addItem.hasMemberInsurance">
                  <v-simple-table class="xBaseTable" dense fixed-header>
                    <template v-slot:default>
                      <thead>
                      <tr>
                        <th class="text-left" v-for="key in memberInsuranceHeader" :class="key.cellClass" :width="key.width">
                          <span v-if="key.required" class="red--text">*</span>{{key.text}}
                        </th>
                      </tr>
                      </thead>
                      <tbody v-if="isEditLoading">
                      <tr>
                        <td colspan="10">
                          <div style="text-align: center">
                          <span><v-progress-circular
                            :size="20"
                            color="primary"
                            indeterminate
                          ></v-progress-circular></span>
                            <span>数据加载中</span>
                          </div>
                        </td>
                      </tr>
                      </tbody>
                      <tbody v-else>
                      <tr
                        v-for="(item, key, index) of addItem.insuranceConfig"
                        :key="key"
                      >
                        <td v-for="fieldItem in memberInsuranceHeader" :key="key"
                            :class="`${fieldItem.cellClass} ${fieldItem.formType === 'text' && 'edit-active'}`"
                            :key="key + '_' + fieldItem.value"
                            >
                          <template v-if="fieldItem.formType === 'select'">
                            <v-autocomplete
                              input-class="quick-focus"
                              :items="constantObj[fieldItem.value]"
                              single-line dense hide-details
                              :label="fieldItem.text"
                              @change="refreshTable(index)"
                              v-model="item[fieldItem.value]">
                            </v-autocomplete>
                          </template>
                          <template v-else>
                            <div :contentEditable="fieldItem.formType === 'text' && !isMobile"
                            @blur="blurTd(item, fieldItem, $event)"
                            @focus="focusTd(item, fieldItem, $event)" class="pa-1">{{item[fieldItem.value]}}</div>
                          </template>
                        </td>
                      </tr>
                      </tbody>
                    </template>
                  </v-simple-table>
                </v-row>
              </v-card>
            </template>
            <!-- 抽屉操作按钮 -->
            <v-row v-if="!isAddDrawerLoading" class="justify-end mx-0 mt-8 px-6">
              <v-btn class="elevation-0 ml-2" @click="isAddDrawerShow = false" small><v-icon size="14">mdi-close</v-icon>取消</v-btn>
              <v-btn color="success" @click="doUiAction('doCreateItem')" small><v-icon size="14">mdi-content-save-check-outline</v-icon>提交</v-btn>
            </v-row>
          </v-form>
          <!-- 抽屉关闭按钮 -->
          <v-btn elevation="0" color="success" fab absolute top left small tile class="drawer-close-float-btn" @click="isAddDrawerShow = false">
            <v-icon>mdi-close</v-icon>
          </v-btn>
        </v-navigation-drawer>

         <!-- 数据导入 -->
      <v-navigation-drawer v-if="importStaff.drawer" v-model="importStaff.drawer" :permanent="importStaff.drawer"  fixed temporary right width="80%" class="elevation-24">

        <!-- 抽屉标题 -->
        <v-row>
          <span class="text-subtitle-1 font-weight-medium pa-6 pl-7">员工数据导入</span>
        </v-row>

        <v-card>
          <v-row class="ma-0 pa-4">
            <v-col cols="3" class="pa-0" style="margin-bottom: -22px;">
              <v-file-input accept=".xlsx" 
                v-model="importStaff.file" label="员工文件" class="elevation-0 mr-2" 
                :clearable="true"
                @change="importStaffFileChange"
                dense filled single-line chips></v-file-input>
            </v-col>

            <v-btn small color="success" class="elevation-0 mr-2" @click="doUiAction('doImportStaffData')">确定导入员工数据</v-btn>

            <v-btn small color="warning" class="elevation-0 mr-2" 
              @click="doUiAction('downloadTemplateData')">下载模版excel</v-btn>
            
            <v-spacer></v-spacer>
      
            <v-col cols="12" xs="5" sm="5" md="3" xl="2" class="pa-0">
              <v-text-field v-model="importStaff.search" prefix="搜索：" class="jh-v-input" dense filled single-line></v-text-field>
            </v-col>

            <v-col cols="12" class="px-0">
              <v-data-table fixed-header
                :headers="importStaffTableHeaders"
                :items="importStaff.tableData"
                :search="importStaff.search"
                :footer-props="{ itemsPerPageOptions: [20, 50, -1], itemsPerPageText: '每页', itemsPerPageAllText: '所有'}"
                :items-per-page="-1"
                mobile-breakpoint="0"
                checkbox-color="success"
                :class="{'zebraLine': isTableZebraLineShown }"
                fixed-header
                class="jh-fixed-table-height elevation-0 mt-0 mb-xs-4">
                <!-- 没有数据 -->
                <template v-slot:loading>
                  <div class="jh-no-data">数据加载中</div>
                </template>
                <template v-slot:no-data>
                  <div class="jh-no-data">暂无数据</div>
                </template>
                <template v-slot:no-results>
                  <div class="jh-no-data">暂无数据</div>
                </template>
                <!-- 表格分页 -->
                <template v-slot:footer.page-text="pagination">
                  <span>{{pagination.pageStart}}-{{pagination.pageStop}}</span>
                  <span class="ml-1">共{{pagination.itemsLength}}条</span>
                </template>
              </v-data-table>
            </v-col>
          </v-row>
        </v-card>

        <v-overlay :value="importStaff.loading" color="white" dark absolute :opacity="0.7">
          <v-progress-circular indeterminate size="32" color="grey"></v-progress-circular>
        </v-overlay>

        <v-btn elevation="0" color="success" fab absolute top left small tile class="drawer-close-float-btn"
          @click="importStaff.drawer = false">
          <v-icon>mdi-close</v-icon>
        </v-btn>
      </v-navigation-drawer>
      </div>

      <!-- 帮助页抽屉 >>>>>>>>>>>>> -->
      <!-- <<<<<<<<<<<<< 帮助页抽屉 -->

    </v-main>
  </v-app>
  <jh-toast />
  <jh-mask />
  <jh-confirm-dialog />
</div>
</script>
<div id="app">
</div>

{% endblock %}

{% block vueScript %}
{% include 'component/jianghuJs/select-appaId.html' %}
{% include 'common/jianghuJs/fixedTableHeightV4.html' %}
{% include 'common/jianghuJs/fixedTableColV4.html' %}
{% include 'component/invoice/invoiceVoucherEntry.html' %}
{% include 'common/excelUtil.html' %}
{% include 'common/vueFilters.html' %}
{% include 'common/constantUtil.html' %}
<script type="module">
  new Vue({
    el: '#app',
    template: '#app-template',
    vuetify: new Vuetify(),
    data: () => ({
      isMobile: window.innerWidth < 500,

      // 面包屑
      breadcrumbs: [
        {
          text: '首页',
          disabled: true,
        },
        {
          text: '员工管理',
          disabled: true,
        }
      ],
      username: window.userInfo.username,
      // 表格相关数据
      isTableZebraLineMenuShown: false,
      tableZebraLineMenuPosition: { x: null, y: null },
      isTableZebraLineShown: true,

      // 表格相关数据
      isFormValid: true,
      validationRules: {
        requireRules: [
          v => !!v || '必填',
        ],
        voucherEntryRules: [
          v => v.length > 0 || '姓名必须少于10个字符',
        ],
      },
      constantObj: {
        subjectList: [],
        sex: ['男', '女'],
        icType: ["身份证"],
        education: ["小学", "初中", "高中", "专科", "本科", "研究生", "硕士"],
        department: [], // 部门
        position: ['岗位1', '岗位2', '岗位3', '岗位4', '岗位5'], // 岗位
        positionLevel: ['普通员工'], // 职级
        entryStatus: ['正式', '离职', '适应期'],
        subjectOfAccruedSalary: ['2211-应付职工薪酬'],
        defaultMemberInsuranceConfig: {}
      },
      showAllField: false,
      serverSearchInput: {},
      searchInput: null,
      isTableLoading: true,
      tableDataFromBackend: [],
      headers: [
        { text: "员工序号", value: "employeeId", sortable: true, cellClass: 'noWrap', formType: 'text', required: true, export: true, defaultShow: true, readonly: true },
        { text: "员工姓名", value: "employeeName", sortable: true, formType: 'text', required: true, cellClass: 'noWrap', export: true, defaultShow: true },
        { text: "性别", value: "sex", sortable: true, cellClass: 'noWrap', required: true, formType: 'select', export: true },
        { text: "证件类型", value: "icType", sortable: true, cellClass: 'noWrap', required: true, formType: 'select', export: true },
        { text: "证件号码", value: "icNumber", sortable: true, cellClass: 'noWrap', formType: 'text', required: true, export: true, defaultShow: true },
        { text: "出生日期", value: "dateOfBirth", sortable: false, cellClass: 'noWrap', formType: 'datePick', required: true, export: true },
        { text: "手机", value: "phone", sortable: false, cellClass: 'noWrap', formType: 'text', required: true, export: true, defaultShow: true },
        { text: "邮箱", value: "email", sortable: true, cellClass: 'noWrap', formType: 'text', required: true, export: true, defaultShow: true },
        { text: "学历", value: "education", sortable: false, required: true, formType: 'select', cellClass: 'noWrap', export: true },
        { text: "银行名称", value: "bankName", sortable: false, formType: 'text', cellClass: 'noWrap', export: true },
        { text: "银行账号", value: "bankAccount", sortable: false, formType: 'text', cellClass: 'noWrap', export: true },
        { text: "入职日期", value: "dateOfEntry", sortable: true, required: true, cellClass: 'noWrap', formType: 'datePick', export: true },
        { text: "部门", value: "department", sortable: false, cellClass: 'noWrap', required: true, formType: 'select', export: true, defaultShow: true },
        { text: "岗位", value: "position", sortable: false, cellClass: 'noWrap', formType: 'select', export: true },
        { text: "职级", value: "positionLevel", sortable: false, formType: 'select', cellClass: 'noWrap', export: true },
        { text: "工资始发日期", value: "dateOfSalary", sortable: false, formType: 'datePick', required: true, cellClass: 'noWrap', export: true },
        { text: "计提工资科目", value: "subjectOfAccruedSalary", sortable: false, formType: 'select', required: true, cellClass: 'noWrap', export: true, defaultShow: true },
        { text: "备注", value: "remark", sortable: false, formType: 'text', cellClass: 'noWrap', export: true },
        { text: "在职状态", value: "entryStatus", sortable: false, formType: 'select', cellClass: 'noWrap', required: true, export: true, defaultShow: true },
        { text: "五险一金配置", value: "insuranceConfig", sortable: false, cellClass: 'noWrap', export: true },

        { text: "操作者", value: "operationByUser", sortable: false, cellClass: 'noWrap' },
        { text: "操作时间", value: "operationAt", sortable: false, cellClass: 'noWrap' },
        { text: "操作", value: "action", align: "center", sortable: false, width: window.innerWidth > 500 ? 120 : 50, class: 'fixed', cellClass: 'fixed', defaultShow: true },
      ],
      memberInsuranceHeader: [
        { text: "名称", value: "name", sortable: false, formType: 'text', width: 150 },
        { text: "缴纳基数", value: "paymentBase", sortable: false, formType: 'text' },
        { text: "个人缴纳比例%", value: "personalRatio", sortable: false, formType: 'text' },
        { text: "个人缴纳金额", value: "personalPay", sortable: false },
        { text: "公司缴纳比例%", value: "companyRatio", sortable: false, formType: 'text' },
        { text: "公司缴纳金额", value: "companyPay", sortable: false },
      ],
      insuranceTdField: [
        { text: "缴纳基数", value: "paymentBase", sortable: false, formType: 'text' },
        { text: "个人缴纳比例%", value: "personalRatio", sortable: false, formType: 'text' },
        { text: "公司缴纳比例%", value: "companyRatio", sortable: false, formType: 'text' },
      ],
      isAddDrawerLoading: false,
      isAddDrawerShow: false,
      addItem: {},
      isEditLoading: false,

      // 员工导入
      importStaff: {
        file: null,
        search: '',
        drawer: false,
        loading: false,
        tableData: [],
      },
    }),
    computed: {
      importStaffTableHeaders() {
        return this.headers.filter(item => item.export)
      },
      tableHeader() {
        const tempTableHeader = this.headers.filter(item => this.showAllField || item.defaultShow);
        if (this.showAllField) {
          const index = tempTableHeader.findIndex(item => item.value === 'insuranceConfig');
          tempTableHeader.splice(index + 1, 0, { text: "养老保险", value: "endowmentInsurance", sortable: false, cellClass: 'noWrap', align: 'center' });
          tempTableHeader.splice(index + 2, 0, { text: "医疗保险", value: "medicalInsurance", sortable: false, cellClass: 'noWrap', align: 'center' });
          tempTableHeader.splice(index + 3, 0, { text: "失业保险", value: "unemploymentInsurance", sortable: false, cellClass: 'noWrap', align: 'center' });
          tempTableHeader.splice(index + 4, 0, { text: "工伤保险", value: "injuryInsurance", sortable: false, cellClass: 'noWrap', align: 'center' });
          tempTableHeader.splice(index + 5, 0, { text: "生育保险", value: "maternityInsurance", sortable: false, cellClass: 'noWrap', align: 'center' });
          tempTableHeader.splice(index + 6, 0, { text: "住房公积金", value: "housingFund", sortable: false, cellClass: 'noWrap', align: 'center' });
          tempTableHeader.splice(index, 1);
        }
        return tempTableHeader;
      },
      tableData() {
        return _.cloneDeep(this.tableDataFromBackend);
      },
      baseFormFields() {
        return this.headers.filter(item => !!item.formType);
      },
    },
    watch: {
      serverSearchInput: {
        deep: true,
        handler(value, oValue) {
        }
      },
    },
    async created() {
      this.doUiAction('getBaseDataList');
      this.doUiAction('refreshTableData');
    },
    mounted() {
    },
    methods: {
      async doUiAction(uiActionId, uiActionData) {
        switch (uiActionId) {
          case 'refreshTableData':
            await this.refreshTableData();
            break;
          case 'getBaseDataList':
            await this.getDepartment();
            await this.getConstantObj();
            await this.getSubjectList();
            break;
          case 'openTableZebraLineMenu':
            await this.openTableZebraLineMenu(uiActionData);
            break;
          case 'startCreateItem':
            await this.openCreateItemDialog();
            await this.prepareCreateItemData(uiActionData);
            break;
          case 'doCreateItem':
            await this.prepareAddItemValidate();
            await this.confirmCreateItemDialog();
            await this.doCreateItem();
            await this.closeCreateItem();
            await this.refreshTableData();
            break;
          case 'startUpdateItem':
            await this.openCreateItemDialog();
            await this.prepareEditItemData(uiActionData);
            break;
          case 'doDeleteItem':
            await this.confirmDeleteItemDialog();
            await this.doDeleteItem(uiActionData);
            await this.refreshTableData();
            break;
          case 'templateFileDownload':
            await this.templateFileDownload(uiActionData);
            break;
          case 'startImportExcel':
            await this.startImportExcel(uiActionData);
            break;
          case 'doImportStaffData':
            await this.doImportStaffData(uiActionData);
            await this.closeImportDrawer();
            await this.refreshTableData();
            break;
          case 'downloadTemplateData':
            await this.downloadTemplateData(uiActionData);
            break;
          default:
            console.error("[doUiAction] uiActionId not find", { uiActionId });
            break;
        }
      },
      // =================================uiAction 公共方法 start ======================================
      /**
       * uiActionId:  prepareValidate
       * description: ✅表单校验
       */
      async prepareAddItemValidate() {
        if (this.$refs.form.validate() === false) {
          window.vtoast.fail({ message: "输入有误, 请检查!" });
          throw new Error("[prepareValidate] 请检查");
        }
        Object.values(this.addItem.insuranceConfig).forEach(item => {
          if (!item.paymentBase) {
            window.vtoast.fail({ message: "输入有误, 请输入五险一金缴纳基数!" });
            throw new Error("[prepareValidate] 请输入五险一金缴纳基数");
          }
        })
      },
      async refreshTableData() {
        this.isTableLoading = true;
        const where = {};
        let appData = {};
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'salary-salaryManagement',
              actionId: 'selectEmployeeList',
              actionData: {},
              where,
              ...appData,
              orderBy: []
            }
          }
        });

        const { rows } = result.data.appData.resultData;
        rows.forEach(item => {
          item.insuranceConfig = item.insuranceConfig ? JSON.parse(item.insuranceConfig) : {};
        })
        this.tableDataFromBackend = rows;
        this.isTableLoading = false;
      },
      // ---------- 斑马纹开关 uiAction >>>>>>>>>> --------
      async openTableZebraLineMenu(funObj) {
        this.tableZebraLineMenuPosition.x = funObj.x - funObj.offsetX + 10;
        this.tableZebraLineMenuPosition.y = window.innerHeight - 50;
        this.isTableZebraLineMenuShown = !this.isTableZebraLineMenuShown;
      },
      // ---------- <<<<<<<<<< 斑马纹开关 uiAction --------
      // =================================uiAction 公共方法 end ======================================
      async getDepartment() {
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'assistManagement',
              actionId: 'assistDepart-selectItemList',
              where: {},
            }
          }
        });
        const { rows } = result.data.appData.resultData;
        rows.forEach(item => {
          item.text = item.assistName;
          item.value = item.assistId;
        })
        this.constantObj.department = rows;
      },
      async getConstantObj() {
        this.isEditLoading = true;
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'allPage',
              actionId: 'getConstantList',
              where: {},
            }
          }
        });
        const { rows } = result.data.appData.resultData;
        const defaultMemberInsuranceConfig = rows.find(item => item.constantKey === 'defaultMemberInsuranceConfig').constantValue;
        this.constantObj.defaultMemberInsuranceConfig = defaultMemberInsuranceConfig ? JSON.parse(defaultMemberInsuranceConfig) : {};
        this.isEditLoading = false;
        if (this.addItem && this.addItem.insuranceConfig && Object.keys(this.addItem.insuranceConfig).length === 0) {
          this.addItem = {
            ...this.addItem,
            insuranceConfig: _.cloneDeep(this.constantObj.defaultMemberInsuranceConfig)
          }
        }
      },
      async getSubjectList() {
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'voucher-voucherManagement',
              actionId: 'selectSubjectList',
              actionData: {},
              where: { subjectHasChildren: '无下级科目' },
              orderBy: [{ column: 'subjectCategory', order: 'desc' }, { column: 'subjectId', order: 'asc' }]
            }
          }
        });
        const { rows } = result.data.appData.resultData;
        rows.forEach(row => {
          row.assistList = row.assistList ? row.assistList.split(',') : [];
        })
        this.constantObj.subjectList = rows;
      },
      // =================================uiAction 创建员工 start ======================================
      async prepareCreateItemData() {
        this.addItem = {};
        this.addItem.insuranceConfig = _.cloneDeep(this.constantObj.defaultMemberInsuranceConfig);
        this.baseFormFields.forEach(item => {
          this.addItem[item.value] = null;
        })
        this.addItem.icType = "身份证";
        this.addItem.entryStatus = "正式";
        const lastId = this.tableDataFromBackend && this.tableDataFromBackend.length ? this.tableDataFromBackend[this.tableDataFromBackend.length - 1].employeeId : 1;
        this.addItem.employeeId = _.padStart(`${parseInt(lastId) + 1}`, 6, '0');
        this.addItem.hasMemberInsurance = 1;
        this.addItem.subjectOfAccruedSalary = "2211-应付职工薪酬";
        this.addItem = { ...this.addItem };
      },
      async prepareEditItemData(item) {
        this.isEditLoading = true;
        this.addItem = _.cloneDeep(item);
        this.isEditLoading = false;
      },

      async openCreateItemDialog() {
        this.isAddDrawerShow = true;
      },

      async confirmCreateItemDialog() {
        if (await window.confirmDialog({ title: this.addItem.id ? "修改" : "新增", content: "确定修改吗？" }) === false) {
          throw new Error("取消");
        }
      },
      async doCreateItem() {
        const { id, insuranceConfig, ...rest } = this.addItem;
        await window.vtoast.loading({ message: `正在${id ? '保存' : '录入'}员工信息`, time: -1 });
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'salary-salaryManagement',
              actionId: id ? 'updateEmployee' : 'createEmployee',
              actionData: {
                ...rest,
                insuranceConfig: JSON.stringify(insuranceConfig)
              },
              ...id ? { where: { id } } : {},
            }
          }
        })
        await window.vtoast.success(`${id ? '保存' : '录入'}员工成功`);
      },
      async closeCreateItem() {
        this.isAddDrawerShow = false;
      },
      // =================================uiAction 创建员工 end ======================================
      async confirmDeleteItemDialog() {
        if (await window.confirmDialog({ title: "删除员工", content: `确定删除该发票吗？` }) === false) {
          throw new Error("取消");
        }
      },

      async doDeleteItem({ id }) {
        window.vtoast.loading({ message: '删除员工', time: -1 });
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'salary-salaryManagement',
              actionId: 'deleteEmployee',
              where: { id },
            }
          }
        });
        window.vtoast.success("删除员工成功");
      },

      async importExcel() {
      },

      async exportExcel() {
      },

      blurTd(item, key, $event) {
        console.log(item, key, $event)
        let diff = false;
        diff = `${isNaN(item[key.value]) ? 0 : item[key.value]}` !== `${isNaN($event.target.innerText) ? 0 : $event.target.innerText}`;
        item[key.value] = parseFloat($event.target.innerText);
        $event.target.innerText = item[key.value];
        if (key.value === 'paymentBase') {
          item.personalPay = parseFloat(item.paymentBase || 0) * parseFloat(item.personalRatio || 0) / 100;
          item.companyPay = parseFloat(item.paymentBase || 0) * parseFloat(item.companyRatio || 0) / 100;
        }
        if (key.value === 'personalRatio') {
          item.personalPay = parseFloat(item.paymentBase || 0) * parseFloat(item.personalRatio || 0) / 100;
        }
        if (key.value === 'companyRatio') {
          item.personalPay = parseFloat(item.paymentBase || 0) * parseFloat(item.personalRatio || 0) / 100;
        }
        this.hasEdit = this.hasEdit || diff;
        if (diff) {
          $event.target.classList.add('changed');
        }
        $event.target.classList.remove('active');
        this.addItem = { ...this.addItem }
      },
      focusTd(item, key, $event) {
        $event.target.innerText = $event.target.innerText || '';
        $event.target.classList.add('active');
      },
      deleteEntryTableItem(index) {
        this.drawFormEntryTable.splice(index, 1);
        this.refreshTable();
      },
      refreshTable(index) {
        if (index) {
          this.drawFormEntryTable[index].invoiceEntryTaxAmount = parseFloat(this.drawFormEntryTable[index].invoiceEntryAmount || 0) * parseFloat(this.drawFormEntryTable[index].invoiceEntryTaxRate) / 100;
        }
        this.drawFormEntryTable = [...this.drawFormEntryTable];
        this.addItem.invoiceTotalPriceAmount = this.drawFormEntryTable.reduce((prev, next) => prev + parseFloat(next.invoiceEntryAmount || 0), 0);
        this.addItem.invoiceTotalTaxAmount = this.drawFormEntryTable.reduce((prev, next) => prev + parseFloat(next.invoiceEntryTaxAmount || 0), 0);
        this.addItem.invoiceTotalPriceAndTaxAmount = parseFloat(this.addItem.invoiceTotalPriceAmount) + parseFloat(this.addItem.invoiceTotalTaxAmount);

        this.addItem = { ...this.addItem }
      },
      onFieldChange(event, key) {
        this.addItem[key] = this.addItem[key].trim();
        if (key === 'icNumber') {
          const reg = /^[1-9]\d{5}(18|19|20)\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/;
          if (!reg.test(this.addItem.icNumber)) {
            return;
          }

          let sexStr = '';
          if (parseInt(this.addItem.icNumber.slice(-2, -1)) % 2 === 1) {
            sexStr = '男';
          } else {
            sexStr = '女';
          }
          this.addItem.sex = sexStr;
          var birthday = '';
          if (this.addItem.icNumber.length === 15) {
            birthday = '19' + this.addItem.icNumber.slice(6, 12);
          } else if (this.addItem.icNumber.length === 18) {
            birthday = this.addItem.icNumber.slice(6, 14);
          }
          this.addItem.dateOfBirth = birthday.replace(/(.{4})(.{2})/, '$1-$2-');
          this.addItem = { ...this.addItem }
        }
      },
      // ---------- 模版excel下载 uiAction >>>>>>>>>>>> --------
      async templateFileDownload({ headers, filename, excelData = [] }) {
        headers = this[headers]
        const params = {
          header: headers.filter(header => !header.exportDisabled).map(header => header.text),
          key: headers.filter(header => !header.exportDisabled).map(header => header.value),
          data: excelData,
          filename: filename,
        };
        excelUtil.exportData(params);
      },

      async process_RS(stream) {
        const buffers = [];
        const reader = stream.getReader();
        for (; ;) {
          const res = await reader.read();
          if (res.value) buffers.push(res.value);
          if (res.done) break;
        }

        /* concat */
        const out = new Uint8Array(buffers.reduce((acc, v) => acc + v.length, 0));

        let off = 0;
        for (const u8 of buffers) {
          out.set(u8, off);
          off += u8.length;
        }
        return out;
      },
      // ---------- <<<<<<<<<<< 模版excel下载 uiAction ---------
      // ---------- 员工导入 >>>>>>>>>>>>> ----------
      async startImportExcel() {
        this.importStaff.drawer = true;
      },
      async importStaffFileChange() {
        if (!this.importStaff.file) {
          this.importStaff.tableData = [];
          return
        }
        this.importStaff.loading = true;
        const data = await this.process_RS(this.importStaff.file.stream());
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet1 = workbook.Sheets[workbook.SheetNames[0]];
        const rowsTemp = XLSX.utils.sheet_to_json(worksheet1);
        const rowsNew = rowsTemp.map(rowTemp => {
          const rowNew = {};
          for (const header of this.importStaffTableHeaders) {
            const { text, value } = header;
            // rowTemp[text]去掉空格
            rowNew[value] = rowTemp[text] ? String(rowTemp[text]).trim() : null;
          }
          // 加上默认的五险 一金配置
          rowNew.hasMemberInsurance = 1
          rowNew.insuranceConfig = JSON.stringify(this.constantObj.defaultMemberInsuranceConfig)
          return rowNew;
        })
        this.importStaff.tableData = rowsNew;
        this.importStaff.loading = false;
        window.resetTableMaxHeight();
      },

      async doImportStaffData() {
        await window.jhMask.show();
        await window.vtoast.loading("员工数据导入");

        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'salary-salaryManagement',
              actionId: 'importEmployeeData',
              actionData: {
                staffList: this.importStaff.tableData,
              },
            }
          }
        })
        await window.jhMask.hide();
        await window.vtoast.success("员工数据导入");
      },
      async closeImportDrawer() {
        this.importStaff.drawer = false;
      },
      async downloadTemplateData() {
        this.doUiAction('templateFileDownload', {  
          'headers': 'importStaffTableHeaders',  
          'filename': '员工数据模版',  
          'excelData': [  
            {  
              'employeeId': 'YG1000',  
              'employeeName': '张三',  
              'sex': '男',  
              'icType': '身份证',  
              'icNumber': '110101198001010011',  
              'dateOfBirth': '1980-01-01',  
              'phone': '13800138000',  
              'email': 'zhangsan@example.com',  
              'education': '本科',  
              'bankName': '中国银行',  
              'bankAccount': '622200000000000001',  
              'dateOfEntry': '2010-01-01',  
              'department': '人力资源部',  
              'position': '经理',  
              'positionLevel': 'P3',  
              'salaryStartDate': '2010-01-01',  
              'dateOfSalary': '2023-10-01',
              'entryStatus': '正式',
            }  
          ]  
        })
      }
      // ---------- <<<<<<<<<<<<< 员工导入 ----------
,
      jumpToUrl() {
        window.open('https://cn.jianghujs.org/doc/page/article/11603', '_blank');
      }
    }   
  })
</script>

<style scoped>
  .invoiceDataType:hover {
    background: #ebecf0;
    cursor: pointer;
  }

  .noWrap {
    white-space: nowrap !important;
  }


  /* 
  .xBaseTable.v-data-table--fixed-header > .v-data-table__wrapper {
    border-top: 1px solid #cccccc;
  }

  .xBaseTable.v-data-table--fixed-header table {
    position: relative;
    transform: translateY(-1px);
  }

  body .xBaseTable.v-data-table--fixed-header thead th {
    border: 1px solid #cccccc !important;
  }

  .xBaseTable {
    padding: 10px;
    min-width: 100%;
  }

  .xBaseTable table {
    border-collapse: collapse;
  } */

  .xBaseTable.v-data-table--fixed-header>.v-data-table__wrapper {
    border: 1px solid #cccccc;
    border-radius: 5px;
  }

  .xBaseTable {
    padding: 10px;
    min-width: 100%;
  }

  .xBaseTable tbody {
    padding-top: 30px;
  }

  body .xBaseTable td.changed {
    background: aliceblue;
  }

  body .xBaseTable td.active {
    background: aliceblue;
    line-height: 40px;
  }

  body .xBaseTable td:not(body .xBaseTable td[contenteditable="true"]):not(body .xBaseTable tr.isFull td) {
    color: #666;
  }

  body .xBaseTable td {
    cursor: text;
  }

  body .xBaseTable tr td:last-child .deletedBtn {
    display: none;
  }

  body .xBaseTable tr:hover td:last-child .deletedBtn {
    display: inline-block;
  }

  body .xBaseTable tr.isFull {
    background: rgba(76, 175, 80, 0.13) !important;
  }

  body .xBaseTable th {
    position: sticky;
    line-height: 40px;
    top: 0;
  }

  body .theme--light.v-data-table.xBaseTable.v-data-table--fixed-header thead th {
    background: #eaeaea !important;
  }


  .cus-date-picker.v-picker table td,
  .cus-date-picker.v-picker table th {
    border: none !important;
  }



  .jh-v-input.required .v-text-field__slot::before {
    margin-right: 3px;
    content: "* ";
    color: red;
  }

  .insuranceTdField {
    flex: 1;
  }

  body .xBaseTable div[contenteditable="true"] {
    border: 1px solid #dddddd !important;
    border-radius: 5px !important;
  }
</style>
{% endblock %}